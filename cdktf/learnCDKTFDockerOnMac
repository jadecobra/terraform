# WIP - Docker provider fails on Apple M1
pause () {
    ls
    echo '\npress [Enter] to  continue...'
    read REPLY
}

brew install jq

open -a Docker
projectName="learn-cdktf-docker"
mkdir $projectName
cd $projectName
pause

echo 'Initializing Terraform Project...'
cdktf init --template=typescript --local
pause

echo 'Installing Docker Provider...'
npm install @cdktf/provider-docker

echo 'Default cdktf.json'
cat cdktf.json
pause
echo 'Adding docker terraform provider...'
cat cdktf.json | jq '.terraformProviders += ["terraform-providers/docker@~>2.0"]' > cdktf.json.tmp
mv cdktf.json.tmp cdktf.json
cat cdktf.json
pause

echo 'Default main.ts file'
cat main.ts
echo 'Replacing main.ts with'
cat << EOF > main.ts
import { Construct } from 'constructs';
import { App, TerraformStack } from 'cdktf';
import { Container, Image, DockerProvider } from './.gen/providers/docker';


class MyStack extends TerraformStack {
    constructor(scope: Construct, name: string) {
        super(scope, name)
        new DockerProvider(this, 'default', {})
        const dockerImage = new Image(this, 'nginxImage', {
            name: 'nginx:latest',
            keepLocally: false,
        })
        new Container(this, 'nginxContainer', {
            image: dockerImage.latest,
            name: 'tutorial',
            ports: [{
                internal: 80,
                external: 8000,
            }]
        })
    }
}

const app = new App();
new MyStack(app, 'typescript-docker')
app.synth
EOF
cat main.ts
pause

echo 'Installing Dependencies...'
cdktf get

echo 'Deploying Container'
cdktf deploy

curl localhost:8000
python3 -m webbrowser localhost:8000

echo 'Listing running Docker containers'
docker ps

echo 'Destroying Stack'
cdktf destroy